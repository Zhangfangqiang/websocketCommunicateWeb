# 聊天功能说明

## 概述

聊天模块提供了完整的实时通信功能，包括文本消息、语音消息、文件传输和视频通话。

## 功能特性

### 1. 文本聊天
- 支持实时文本消息发送
- 消息历史记录
- 无限滚动加载
- 消息时间戳显示

### 2. 语音聊天
- 语音录制和发送
- 支持WAV格式
- 权限检查和错误处理
- 实时播放控制

### 3. 文件传输
- 支持多种文件格式
- 图片预览功能
- 文件类型识别
- 安全上传机制

### 4. 视频通话 ✨ 新功能
- 基于WebRTC的P2P视频通话
- 支持摄像头和麦克风
- 实时音视频流传输
- 通话状态管理
- 来电接听/拒接
- 响应式视频界面

## 技术架构

### WebRTC实现
- 使用RTCPeerConnection建立P2P连接
- STUN服务器进行NAT穿透
- ICE候选处理
- 媒体流管理

### 消息协议
- Protocol Buffers序列化
- WebSocket实时传输
- 消息类型分类
- 状态同步机制

## 使用方法

### 发起视频通话
1. 选择聊天对象
2. 点击视频通话按钮
3. 允许摄像头和麦克风权限
4. 等待对方接听

### 接听视频通话
1. 收到来电通知
2. 选择接听或拒接
3. 允许媒体权限
4. 开始视频通话

### 结束通话
- 点击"结束通话"按钮
- 或关闭通话窗口

## 组件结构

```
src/views/home/chat/
├── index.tsx              # 主聊天组件
├── c-cpns/                # 子组件
│   ├── ChatAudio.tsx      # 语音聊天组件
│   ├── ChatFile.tsx       # 文件传输组件
│   ├── ChatVideo.tsx      # 视频通话组件 ✨
│   └── ChatWindowDetails.tsx # 聊天设置组件
├── proto/                 # 消息协议定义
│   ├── message.proto      # Protocol Buffers定义
│   ├── message.js         # 生成的JavaScript代码
│   └── message.d.ts       # TypeScript类型定义
└── README.md              # 本文档
```

## 配置说明

### 媒体权限
- 摄像头权限：用于视频通话
- 麦克风权限：用于音频通话
- 自动权限检查和提示

### 网络配置
- STUN服务器：Google公共STUN服务器
- WebSocket连接：实时消息传输
- 心跳检测：保持连接活跃

## 注意事项

1. **浏览器兼容性**：需要支持WebRTC的现代浏览器
2. **网络环境**：建议在稳定的网络环境下使用
3. **隐私保护**：通话过程中会使用摄像头和麦克风
4. **资源管理**：通话结束后会自动释放媒体资源

## 故障排除

### 常见问题
1. **无法获取摄像头权限**
   - 检查浏览器权限设置
   - 确保设备有可用的摄像头

2. **视频通话连接失败**
   - 检查网络连接
   - 确认防火墙设置
   - 尝试刷新页面

3. **音视频质量问题**
   - 检查网络带宽
   - 调整摄像头分辨率
   - 关闭其他占用带宽的应用

## 更新日志

### v1.1.0 - 新增视频通话功能
- 实现基于WebRTC的视频通话
- 添加通话状态管理
- 优化用户界面和用户体验
- 增加响应式设计支持

### v1.0.0 - 基础聊天功能
- 文本消息发送
- 语音录制功能
- 文件传输支持
- 实时通信架构
